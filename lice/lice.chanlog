#
#   IRC Script Program. For use with ircii-EPIC5 clients.
#   Copyright (C) 2000 whitefang (thall@magenet.com) - Broken email.
#
# ---------------------------------------------------------------------------
# All code by whitefang, unless specified. Visit http://wolf.magenet.com
# ---------------------------------------------------------------------------
#
# Prior to LiCe 5.3 this file was taken from whitefang's wolf addon for LiCe4
# Since LiCe 5.3 we now use epic5's built in logging function.
#

IF (word(2 $loadinfo()) != [pf]) {
  LOAD -pf $word(1 $loadinfo());
  RETURN;
};

PACKAGE LiCe;

# Setup logging
@ mkdir($lice.save_path/logs);
SET NO_CONTROL_LOG OFF;

ALIAS chanlog {
  UNLESS (@) {
    uecho Usage: /CHANLOG -a <channel>;
    uecho Usage: /CHANLOG -d <channel>;
    uecho Usage: /CHANLOG -l <channel>;
    RETURN;
  };
  @ :opts = [];
  WHILE (opts = getopt(optopt optarg "a:d:l::" $*)) {
    @ :chan = optarg;
    UNLESS (ischannel($chan)) {@ chan = [#] ## chan};
    @ :hash = hash_32bit($chan);
    SWITCH ($opts) {
      (a) {
        FE ($logctl(REFNUMS ALL)) logs {
          IF ((logctl(GET $logs NAME)) == [$chan]) {
          iecho Already logging $chan;
          RETURN;
          };
        };
        _proc.startlog $chan;
        @lice.set(![$hash][C] $chan);
        iecho Chanlog: logging $chan to $lice.save_path/logs/$tolower($chan)\.log;
        CONTINUE;
      };
      (d) {
        @ rmlog = 0;
        FE ($logctl(REFNUMS ALL)) logs {
          IF ((logctl(GET $logs NAME)) == [$chan]) {
            @ rmlog = logs;
          };
        };
        UNLESS (rmlog) {
          iecho $chan isn't being logged, unable to delete;
          RETURN;
        };
        //^LOG $rmlog KILL;
        @lice.del(![$hash][C]);
        iecho Chanlog: no longer logging $chan;
      };
      (l) {
        iecho - Channel $repeat(21 -) Path $repeat(40 -) Size $repeat(8 -);
        FE ($logctl(REFNUMS ALL)) logs {
          @ :chan = logctl(GET $logs NAME);
          @ :dotspin1 = (30 - strlen($chan));
          @ :dotspin2 = (44 - strlen($lice.save_path/logs/$tolower($chan)\.log));
          iecho $logctl(GET $logs NAME) $repeat($dotspin1  ) $lice.save_path/logs/$tolower($chan)\.log $repeat($dotspin2  ) $fsize( $lice.save_path/logs/$tolower($chan)\.log);
        };
      };
    }};
  };
};

ALIAS _proc.startlog (channel) {
  //^LOG NEW NAME $channel FILENAME $lice.save_path/logs/$tolower($channel)\.log ADD $channel MANGLE ALL REWRITE "$$strftime(%b %d %X): $$1-" ON;
};

#Hacked into LiCe beautifully, before epic supported logging, by tjbh/2000 - wolf script
#Rewrite for epic's built-in logging by tjh
#tjh/14
